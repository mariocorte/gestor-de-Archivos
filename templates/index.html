<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sincronizador Orion</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  </head>
  <body>
    <main class="container">
      <h1>Sincronización de archivos Orion</h1>
      <p class="intro">
        Completa los datos de conexión y ejecuta la sincronización directamente desde tu navegador.
        Las opciones de codificación permiten manejar nombres de archivo con caracteres especiales.
      </p>

      <form method="post" class="card">
        <section>
          <h2>Servidor SFTP</h2>
          <div class="field">
            <label for="sftp_host">Host</label>
            <input type="text" id="sftp_host" name="sftp_host" value="{{ form.sftp_host }}" required>
          </div>
          <div class="field grid">
            <div>
              <label for="sftp_port">Puerto</label>
              <input type="number" id="sftp_port" name="sftp_port" value="{{ form.sftp_port }}" min="1" max="65535" required>
            </div>
            <div>
              <label for="sftp_username">Usuario</label>
              <input type="text" id="sftp_username" name="sftp_username" value="{{ form.sftp_username }}">
            </div>
          </div>
          <div class="field grid">
            <div>
              <label for="sftp_password">Contraseña</label>
              <input type="password" id="sftp_password" name="sftp_password" value="{{ form.sftp_password }}">
            </div>
            <div>
              <label for="sftp_private_key">Clave privada (opcional)</label>
              <input type="text" id="sftp_private_key" name="sftp_private_key" value="{{ form.sftp_private_key }}" placeholder="/ruta/a/id_rsa">
            </div>
          </div>
          <div class="field">
            <label for="sftp_passphrase">Passphrase de la clave</label>
            <input type="password" id="sftp_passphrase" name="sftp_passphrase" value="{{ form.sftp_passphrase }}">
          </div>
          <div class="field">
            <label for="sftp_base_path">Ruta base</label>
            <input type="text" id="sftp_base_path" name="sftp_base_path" value="{{ form.sftp_base_path }}" required>
          </div>
          <div class="field">
            <label for="sftp_encodings">Codificaciones (orden de prioridad)</label>
            <input type="text" id="sftp_encodings" name="sftp_encodings" value="{{ form.sftp_encodings }}" placeholder="utf-8, latin-1, cp1252">
            <p class="hint">Se probarán en el orden indicado hasta que la lista de archivos sea exitosa.</p>
          </div>
        </section>

        <section>
          <h2>Destino en Amazon S3</h2>
          <div class="field">
            <label for="s3_bucket">Bucket</label>
            <input type="text" id="s3_bucket" name="s3_bucket" value="{{ form.s3_bucket }}" required>
          </div>
          <div class="field">
            <label for="s3_prefix">Prefijo (carpeta)</label>
            <input type="text" id="s3_prefix" name="s3_prefix" value="{{ form.s3_prefix }}" placeholder="videosorion">
          </div>
          <div class="field">
            <label for="aws_region">Región de AWS</label>
            <input type="text" id="aws_region" name="aws_region" value="{{ form.aws_region }}" placeholder="us-east-1">
          </div>
          <div class="field">
            <label for="s3_endpoint_url">Endpoint personalizado</label>
            <input type="text" id="s3_endpoint_url" name="s3_endpoint_url" value="{{ form.s3_endpoint_url }}" placeholder="http://dc-s3.justiciasalta.gov.ar">
            <p class="hint">Úsalo para servicios compatibles con S3 que no sean AWS.</p>
          </div>
          <div class="field">
            <label for="aws_access_key_id">Access Key ID</label>
            <input type="text" id="aws_access_key_id" name="aws_access_key_id" value="{{ form.aws_access_key_id }}" placeholder="ACCESS_KEY">
          </div>
          <div class="field">
            <label for="aws_secret_access_key">Secret Access Key</label>
            <input type="password" id="aws_secret_access_key" name="aws_secret_access_key" value="{{ form.aws_secret_access_key }}" placeholder="SECRET_KEY">
            <p class="hint">Por seguridad no se mostrará al recargar la página.</p>
          </div>
          <div class="field">
            <label for="allowed_extensions">Extensiones permitidas (opcional)</label>
            <input type="text" id="allowed_extensions" name="allowed_extensions" value="{{ form.allowed_extensions }}" placeholder="mp4, mov, zip">
          </div>
          <div class="field checkbox">
            <label>
              <input type="checkbox" name="delete_remote_after_upload" value="true" {% if form.delete_remote_after_upload %}checked{% endif %}>
              Eliminar archivo remoto tras subirlo a S3
            </label>
          </div>
        </section>

        <section>
          <h2>Opciones de ejecución</h2>
          <div class="field checkbox">
            <label>
              <input type="checkbox" name="dry_run" value="true" {% if form.dry_run %}checked{% endif %}>
              Simulación (dry-run)
            </label>
          </div>
          <div class="field checkbox">
            <label>
              <input type="checkbox" name="list_only" value="true" {% if form.list_only %}checked{% endif %}>
              Solo listar archivos sin subir
            </label>
          </div>
        </section>

        <div class="actions">
          <button type="submit">Ejecutar sincronización</button>
        </div>
      </form>

      {% if error %}
      <section class="card error">
        <h2>Ocurrió un problema</h2>
        <p>{{ error }}</p>
      </section>
      {% endif %}

      {% if summary %}
      <section class="card">
        <h2>Resumen de la ejecución</h2>
        <ul>
          <li><strong>Codificación utilizada:</strong> {{ summary.encoding_used }}</li>
          <li><strong>Archivos remotos:</strong> {{ summary.total_remote_files }}</li>
          {% if not summary.list_only %}
          <li><strong>Subidos a S3:</strong> {{ summary.uploaded_files }}</li>
          <li><strong>Omitidos por existir:</strong> {{ summary.skipped_existing }}</li>
          {% if summary.deleted_remote %}
          <li><strong>Eliminados en origen:</strong> {{ summary.deleted_remote }}</li>
          {% endif %}
          {% endif %}
          {% if summary.dry_run %}
          <li><strong>Modo simulación activado.</strong></li>
          {% endif %}
        </ul>
      </section>
      {% endif %}

      {% if logs %}
      <section class="card logs">
        <h2>Registro de la ejecución</h2>
        <pre>{{ logs }}</pre>
      </section>
      {% endif %}
    </main>
  </body>
</html>
