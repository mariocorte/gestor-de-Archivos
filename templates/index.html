<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sincronizador Orion</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  </head>
  <body>
    <main class="container">
      <h1>Sincronización de archivos Orion</h1>
      <p class="intro">
        Completa los datos de conexión y ejecuta la sincronización directamente desde tu navegador.
        Las opciones de codificación permiten manejar nombres de archivo con caracteres especiales.
      </p>

      <form method="post" class="card">
        <section>
          <h2>Servidor SFTP</h2>
          <div class="field">
            <label for="sftp_host">Host</label>
            <input type="text" id="sftp_host" name="sftp_host" value="{{ form.sftp_host }}" required>
          </div>
          <div class="field grid">
            <div>
              <label for="sftp_port">Puerto</label>
              <input type="number" id="sftp_port" name="sftp_port" value="{{ form.sftp_port }}" min="1" max="65535" required>
            </div>
            <div>
              <label for="sftp_username">Usuario</label>
              <input type="text" id="sftp_username" name="sftp_username" value="{{ form.sftp_username }}">
            </div>
          </div>
          <div class="field grid">
            <div>
              <label for="sftp_password">Contraseña</label>
              <input type="password" id="sftp_password" name="sftp_password" value="{{ form.sftp_password }}">
            </div>
            <div>
              <label for="sftp_private_key">Clave privada (opcional)</label>
              <input type="text" id="sftp_private_key" name="sftp_private_key" value="{{ form.sftp_private_key }}" placeholder="/ruta/a/id_rsa">
            </div>
          </div>
          <div class="field">
            <label for="sftp_passphrase">Passphrase de la clave</label>
            <input type="password" id="sftp_passphrase" name="sftp_passphrase" value="{{ form.sftp_passphrase }}">
          </div>
          <div class="field">
            <label for="sftp_base_path">Ruta base</label>
            <input type="text" id="sftp_base_path" name="sftp_base_path" value="{{ form.sftp_base_path }}" required>
          </div>
          <div class="field">
            <label for="sftp_encodings">Codificaciones (orden de prioridad)</label>
            <input type="text" id="sftp_encodings" name="sftp_encodings" value="{{ form.sftp_encodings }}" placeholder="utf-8, latin-1, cp1252">
            <p class="hint">Se probarán en el orden indicado hasta que la lista de archivos sea exitosa.</p>
          </div>
        </section>

        <section>
          <h2>Destino en Amazon S3</h2>
          <div class="field">
            <label for="s3_bucket">Bucket</label>
            <input type="text" id="s3_bucket" name="s3_bucket" value="{{ form.s3_bucket }}" required>
          </div>
          <div class="field">
            <label for="s3_prefix">Prefijo (carpeta)</label>
            <input type="text" id="s3_prefix" name="s3_prefix" value="{{ form.s3_prefix }}" placeholder="videosorion">
          </div>
          <div class="field">
            <label for="aws_region">Región de AWS</label>
            <input type="text" id="aws_region" name="aws_region" value="{{ form.aws_region }}" placeholder="us-east-1">
          </div>
          <div class="field">
            <label for="allowed_extensions">Extensiones permitidas (opcional)</label>
            <input type="text" id="allowed_extensions" name="allowed_extensions" value="{{ form.allowed_extensions }}" placeholder="mp4, mov, zip">
          </div>
          <div class="field checkbox">
            <label>
              <input type="checkbox" name="delete_remote_after_upload" value="true" {% if form.delete_remote_after_upload %}checked{% endif %}>
              Eliminar archivo remoto tras subirlo a S3
            </label>
          </div>
        </section>

        <section>
          <h2>Opciones de ejecución</h2>
          <div class="field checkbox">
            <label>
              <input type="checkbox" name="dry_run" value="true" {% if form.dry_run %}checked{% endif %}>
              Simulación (dry-run)
            </label>
          </div>
          <div class="field checkbox">
            <label>
              <input type="checkbox" name="list_only" value="true" {% if form.list_only %}checked{% endif %}>
              Solo listar archivos sin subir
            </label>
          </div>
        </section>

        {% if plan %}
        <section class="transfer-plan" data-total-missing="{{ plan.total_missing_bytes }}">
          <input type="hidden" name="selected_files_payload" value='{{ selected_files|tojson }}'>
          <h2>Archivos detectados en el origen</h2>
          <p class="hint">
            Codificación utilizada: <strong>{{ plan.encoding }}</strong>. Se encontraron
            <strong>{{ plan.remote_total }}</strong> archivos y
            <strong>{{ plan.existing_count }}</strong> ya existen en el destino.
          </p>
          {% if plan.missing_files %}
          <div class="selection-actions">
            <div class="selection-buttons">
              <button type="button" class="secondary outline" data-action="select-all">Seleccionar todos</button>
              <button type="button" class="secondary outline" data-action="select-none">Deseleccionar todos</button>
            </div>
            <div class="selection-count">
              Seleccionados <strong data-selected-count>{{ selected_files|length }}</strong>
              de {{ plan.missing_count }} pendientes.
            </div>
          </div>
          <ul class="file-list selectable">
            {% for item in plan.missing_files %}
            <li>
              <label class="file-option">
                <input type="checkbox" name="selected_files" value="{{ item.remote_path }}" data-size="{{ item.size }}" {% if item.remote_path in selected_files %}checked{% endif %}>
                <span class="file-name">{{ item.remote_path }}</span>
                <span class="file-meta">{{ item.s3_key }} · {{ item.size_label }}</span>
              </label>
            </li>
            {% endfor %}
          </ul>
          <p class="hint total-size">
            Tamaño seleccionado: <strong data-selected-size>{{ plan.selected_total_label }}</strong>
            de {{ plan.total_missing_label }} disponibles.
          </p>
          {% else %}
          <p class="hint">
            No hay archivos pendientes de copiar: todos los archivos remotos ya están en el destino.
          </p>
          {% endif %}
        </section>
        <section class="existing-files">
          <h2>Archivos existentes en S3</h2>
          {% if plan.existing_files %}
          <ul class="file-list existing">
            {% for item in plan.existing_files %}
            <li>
              <span class="file-name">{{ item.key }}</span>
              <span class="file-meta">{{ item.size_label }}</span>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="hint">No se encontraron archivos en el destino con el prefijo indicado.</p>
          {% endif %}
        </section>
        {% endif %}

        <div class="actions">
          <button type="submit" name="operation" value="list" class="secondary">
            {% if plan %}Actualizar listado{% else %}Listar archivos disponibles{% endif %}
          </button>
          {% if plan and plan.missing_count %}
          <button type="submit" name="operation" value="sync">Copiar seleccionados</button>
          {% endif %}
        </div>
      </form>

      {% if error %}
      <section class="card error">
        <h2>Ocurrió un problema</h2>
        <p>{{ error }}</p>
      </section>
      {% endif %}

      {% if summary %}
      <section class="card">
        <h2>Resumen de la ejecución</h2>
        <ul>
          <li><strong>Codificación utilizada:</strong> {{ summary.encoding_used }}</li>
          <li><strong>Archivos remotos:</strong> {{ summary.total_remote_files }}</li>
          <li><strong>Archivos seleccionados:</strong> {{ summary.selected_files }}</li>
          {% if not summary.list_only %}
          <li><strong>Subidos a S3:</strong> {{ summary.uploaded_files }}</li>
          <li><strong>Omitidos por existir:</strong> {{ summary.skipped_existing }}</li>
          <li><strong>Tamaño transferido:</strong> {{ summary.total_transferred|human_size }} / {{ summary.total_bytes|human_size }}</li>
          {% if summary.deleted_remote %}
          <li><strong>Eliminados en origen:</strong> {{ summary.deleted_remote }}</li>
          {% endif %}
          {% endif %}
          {% if summary.dry_run %}
          <li><strong>Modo simulación activado.</strong></li>
          {% endif %}
        </ul>
      </section>
      {% endif %}

      {% if summary %}
      <section class="card progress-card">
        <h2>Avance de la copia</h2>
        <div class="progress-overall">
          <div class="progress-header">
            <span>Total transferido</span>
            <span>{{ '%.1f' % summary.total_percentage }}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: {{ summary.total_percentage }}%"></div>
          </div>
          <p class="progress-meta">{{ summary.total_transferred|human_size }} de {{ summary.total_bytes|human_size }}</p>
        </div>
        {% if summary.progress %}
        <ul class="progress-list">
          {% for item in summary.progress %}
          <li>
            <div class="progress-header">
              <span class="file-name">{{ item.s3_key }}</span>
              <span class="percentage">{{ '%.1f' % item.percentage }}%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: {{ item.percentage }}%"></div>
            </div>
            <p class="progress-meta">{{ item.transferred|human_size }} de {{ item.size|human_size }}</p>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="hint">No hubo archivos para copiar en esta ejecución.</p>
        {% endif %}
      </section>
      {% endif %}

      {% if logs %}
      <section class="card logs">
        <h2>Registro de la ejecución</h2>
        <pre>{{ logs }}</pre>
      </section>
      {% endif %}
    </main>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const planSection = document.querySelector('.transfer-plan');
        if (!planSection) {
          return;
        }
        const checkboxes = Array.from(planSection.querySelectorAll('input[name="selected_files"]'));
        const selectAllBtn = planSection.querySelector('[data-action="select-all"]');
        const selectNoneBtn = planSection.querySelector('[data-action="select-none"]');
        const countEl = planSection.querySelector('[data-selected-count]');
        const sizeEl = planSection.querySelector('[data-selected-size]');
        const payloadInput = planSection.querySelector('input[name="selected_files_payload"]');

        const formatSize = (bytes) => {
          const units = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
          let size = bytes;
          for (const unit of units) {
            if (size < 1024 || unit === units[units.length - 1]) {
              if (unit === 'B') {
                return `${Math.round(size)} ${unit}`;
              }
              return `${size.toFixed(2)} ${unit}`;
            }
            size /= 1024;
          }
          return `${size.toFixed(2)} PB`;
        };

        const updateSelection = () => {
          let total = 0;
          let count = 0;
          const selectedValues = [];
          for (const checkbox of checkboxes) {
            if (checkbox.checked) {
              count += 1;
              total += Number(checkbox.dataset.size || '0');
              selectedValues.push(checkbox.value);
            }
          }
          if (countEl) {
            countEl.textContent = count;
          }
          if (sizeEl) {
            sizeEl.textContent = formatSize(total);
          }
          if (payloadInput) {
            payloadInput.value = JSON.stringify(selectedValues);
          }
        };

        selectAllBtn?.addEventListener('click', (event) => {
          event.preventDefault();
          checkboxes.forEach((checkbox) => {
            checkbox.checked = true;
          });
          updateSelection();
        });

        selectNoneBtn?.addEventListener('click', (event) => {
          event.preventDefault();
          checkboxes.forEach((checkbox) => {
            checkbox.checked = false;
          });
          updateSelection();
        });

        checkboxes.forEach((checkbox) => {
          checkbox.addEventListener('change', updateSelection);
        });

        updateSelection();
      });
    </script>
  </body>
</html>
